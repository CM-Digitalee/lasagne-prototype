<div class="p-40">
  <form #form="ngForm" (ngSubmit)="budgetService.add(form.value)">
    <mat-form-field class="mr-20">
      <mat-label>Portfolio</mat-label>
      <mat-select #portfolioSelect="ngModel" name="portfolioId" ngModel (ngModelChange)="assetSelect.reset()">
        <mat-option *ngFor="let portfolio of portfolioService.portfolios$ | async" [value]="portfolio.id">
          {{ portfolio.name }}
        </mat-option>
      </mat-select>
    </mat-form-field>

    <mat-form-field class="mr-20">
      <mat-label>Asset</mat-label>
      <!-- TODO <mat-select #assetSelect="ngModel" name="assetId" ngModel (ngModelChange)="budgetSelect?.reset()" [disabled]="!portfolioSelect.value"> -->
      <mat-select #assetSelect="ngModel" name="assetId" ngModel [disabled]="!portfolioSelect.value">
        <mat-option *ngFor="let asset of assetService.assets$ | async | filterBy: 'portfolioId': portfolioSelect.value"
          [value]="asset.id">
          {{ asset.name }}
        </mat-option>
      </mat-select>
    </mat-form-field>

    <ng-container
      *ngIf="budgetService.budgets$ | async | filterBy: 'portfolioId': portfolioSelect.value| filterBy: 'assetId': assetSelect.value as budgets">
      <mat-form-field class="mr-20">
        <mat-label>Budget</mat-label>
        <mat-select #budgetSelect="ngModel" [ngModel]="assetSelect.value && !budgets.length && 'noBudget'"
          [ngModelOptions]="{standalone: true}" [disabled]="!assetSelect.value || !budgets.length">
          <ng-container *ngIf="budgets.length else noBudget">
            <mat-option *ngFor="let budget of budgets" [value]="budget">
              {{ budget.name }}
            </mat-option>
          </ng-container>
          <ng-template #noBudget>
            <mat-option value="noBudget">Aucun budget</mat-option>
          </ng-template>
        </mat-select>
      </mat-form-field>

      <button type="button" #createBtn *ngIf="portfolioSelect.value && assetSelect.value && !budgets.length"
        (click)="budgetFormAccordion.open()">
        Create
      </button>
    </ng-container>

    <div cdkAccordionItem #budgetFormAccordion="cdkAccordionItem">
      <ng-container *ngIf="budgetFormAccordion.expanded && budget$ | async as budget">
        <mat-form-field>
          <mat-label>Name</mat-label>
          <input matInput name="name" ngModel>
        </mat-form-field>

        <ng-template #nodeTmpl let-node="node" let-totalParent="totalParent" let-level="level">
          <ng-container *ngIf="node.children else leafTmpl" #accordionItem="cdkAccordionItem" cdkAccordionItem expanded>
            <div class="line flex pointer" (click)="accordionItem.toggle()" total [totalParent]="totalParent"
              #total="total">
              <div class="label flex align-center" [style.padding-left.px]="level*30">
                <i class="material-icons expand-icon" [ngClass]="{'expanded': accordionItem.expanded}">expand_less</i>
                <span>{{ node.label }}</span>
              </div>
              <span class="item">{{ total.total | number }}</span>
              <span class="item">
                {{ total.totalRoot.totalRevenue ? (total.total / total.totalRoot.totalRevenue | percent: '1.2-2') : 'x' }}
              </span>
              <span class="item">
                {{ total.totalRoot.totalOpex ? (total.total / total.totalRoot.totalOpex | percent: '1.2-2') : 'x' }}
              </span>
            </div>
            <div [@expand]="accordionItem.expanded" style="overflow: hidden;">
              <ng-container *ngFor="let node of node.children">
                <ng-container *ngTemplateOutlet="nodeTmpl; context: {node: node, totalParent: total, level: level + 1}">
                </ng-container>
              </ng-container>
            </div>
          </ng-container>

          <ng-template #leafTmpl>
            <div *permissions="{AM: true, PM: node.accountIsPmVisible}" class="line flex" total
              [totalParent]="totalParent" [isRevenue]="!!node.accountIsRevenue" [isOpex]="!!node.accountIsOpex"
              #total="total">
              <span class="label" [style.padding-left.px]="level*30">
                {{ node.subAccountDescription || node.accountDescription }}
              </span>
              <!-- TODO: refacto permissions -->
              <input *permissions="{PM: true, AM: !node.accountIsPmVisible}" type="number"
                [name]="node.subAccount ? node.account + '/' + node.subAccount : node.account" ngModel
                (ngModelChange)="total.value = +$event" class="item">
              <input *permissions="{AM: node.accountIsPmVisible}" type="number"
                [name]="node.subAccount ? node.account + '/' + node.subAccount : node.account" ngModel
                (ngModelChange)="total.value = +$event" disabled class="item">
              <span class="item">
                {{ total.totalRoot.totalRevenue ? (total.total / total.totalRoot.totalRevenue | percent: '1.2-2') : 'x' }}
              </span>
              <span class="item">
                {{ total.totalRoot.totalOpex ? (total.total / total.totalRoot.totalOpex | percent: '1.2-2') : 'x' }}
              </span>
            </div>
          </ng-template>
        </ng-template>

        <div class="line header flex">
          <div class="label">Category</div>
          <div class="item">Budget 2021</div>
          <div class="item">% of Rental Income</div>
          <div class="item">% of Rental Expenses</div>
        </div>

        <div total #total="total" class="ov-auto" style="height: calc(100vh - 250px);">
          <ng-container *ngFor="let node of budget">
            <ng-container *ngTemplateOutlet="nodeTmpl; context: {node: node, totalParent: total, level: 0}">
            </ng-container>
          </ng-container>
        </div>
        <div class="flex justify-end">
          <button type="submit">Enregistrer</button>
        </div>
      </ng-container>
    </div>
  </form>
</div>